name: Ensure All Code Owners Approve

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check-approvals:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Define Code Owners
        id: codeowners
        run: |
          CODEOWNERS=("Vinod" "Rajesh")
          echo "Code Owners: ${CODEOWNERS[@]}"
          echo "::set-output name=codeowners::${CODEOWNERS[@]}"

      - name: Check Approvals
        id: approvals
        run: |
          # Get the list of users who approved the PR
          APPROVED_USERS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews" \
          | jq -r '.[] | select(.state == "APPROVED") | .user.login')

          echo "Approved users: $APPROVED_USERS"

          # Initialize approval count
          APPROVAL_COUNT=0

          # Check if approvals come from all code owners
          for owner in "${CODEOWNERS[@]}"; do
            if echo "$APPROVED_USERS" | grep -qw "$owner"; then
              ((APPROVAL_COUNT++))
            fi
          done

          echo "Number of code owner approvals: $APPROVAL_COUNT"

          if [ "$APPROVAL_COUNT" -ne "${#CODEOWNERS[@]}" ]; then
            echo "Not all code owners have approved. PR cannot be merged."
            exit 1
          else
            echo "All code owners have approved the PR."
          fi

      - name: Approvals Check Passed
        if: success()
        run: echo "PR is ready to merge after all code owners' approval."
